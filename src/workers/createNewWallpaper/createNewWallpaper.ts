import { TaskProgress } from '../../components/TaskInProgress/task/TaskProgress';
import { addWallpaperComputables } from '../../utils/addWallpaperComputables';
import { serializeWallpaper } from '../../utils/hydrateWallpaper';
import { getSupabaseForWorker } from '../../utils/supabase/getSupabaseForWorker';
import {
    description,
    string_markdown,
    string_name,
    string_translate_language,
    string_url,
    string_wallpaper_id,
    title,
    uuid,
} from '../../utils/typeAliases';
import { createNewWallpaper_image } from './createNewWallpaper_image';
import { createNewWallpaper_text } from './createNewWallpaper_text';

export interface CreateNewWallpaperRequest {
    /**
     * The language
     * - It is used to select the right prompt template pipeline
     * - The interaction with the user is in this language
     * - The generated content is in this language
     */
    locale: string_translate_language;

    /**
     * Title of the wallpaper
     *
     * If set, the generated content will start with this title
     * If null, it will be written by AI
     */
    readonly title: Exclude<title, JSX.Element> | null;

    /**
     * Author of the wallpaper
     * Note: It must be valid client ID and same as identity of the user
     */
    readonly author: uuid;

    /**
     * Image of the wallpaper
     */
    readonly wallpaperImage: Blob;

    /**
     * Description of the wallpaper
     * It can be:
     * - **prompt** from MidJourney
     * - **alt** text
     * - **null**, in that case it will be generated by AI
     *
     * Note: There are two simmilar properties, provide only one of them:
     * - `description` which describes content of the image
     * - `assigment` which describes requirements for the page
     */
    readonly description: Exclude<description, JSX.Element> | null;

    /**
     * Assigment of the wallpaper
     *
     * It is the detailed description of the wallpaper, please include information like:
     * - What is the page about
     * - What is the goal of the page
     * - What is the user supposed to do on the page
     *
     * Note: There are two simmilar properties, provide only one of them:
     * - `description` which describes content of the image
     * - `assigment` which describes requirements for the page
     */
    readonly assigment?: Exclude<description, JSX.Element> | null;

    /**
     * Additional sections to be added to the content
     */
    readonly addSections: Array<{
        /**
         * Unique name of the section
         * Note: It is used for example as element ID to lead anchor links to this section
         */
        readonly name: string_name;

        /**
         * Title of the section
         */
        readonly title: Exclude<title, JSX.Element>;

        /**
         * Order of the section
         * TODO: [ðŸ§ ] Some transparent system to order sections
         */
        readonly order: number;

        /**
         * Content of the section
         */
        readonly content: string_markdown;

        // <- TODO: !! [ðŸ§ ] Maybe allow to have empty name+title+content just write assigment and auto generate
    }>;

    /**
     * Links to be added to the content
     */
    readonly links: Array<{
        /**
         * Title of the link - it is used as link text and also as title attribute
         */
        readonly title: Exclude<title, JSX.Element>;

        /**
         * URL of the link
         */
        readonly url: string_url;
    }>;
}

export interface CreateNewWallpaperResult {
    readonly wallpaperId: string_wallpaper_id;
}

/**
 * Create a new wallpaper
 *
 * @workerify Do not use directly, use createNewWallpaperForBrowser instead
 * @private Use only withing the folder createNewWallpaper
 */
export async function createNewWallpaper(
    request: CreateNewWallpaperRequest,
    onProgress: (taskProgress: TaskProgress) => void,
): Promise<CreateNewWallpaperResult> {
    const { locale, title, description, author, wallpaperImage, links, addSections } = request;

    const { wallpaperUrl, originalSize, colorStats } = await createNewWallpaper_image(
        { author, wallpaperImage },
        onProgress,
    );
    const { contentWithFont } = await createNewWallpaper_text(
        {
            locale,
            title,
            description,
            author,
            links,
            addSections,
        },
        onProgress,
    );

    //===========================================================================
    //-------[ Save: ]---
    await onProgress({
        name: 'finishing',
        title: 'Finishing',
        isDone: false,
        // Note: No need to end this task, because it is the last one and will be ended by navigation to new page
    });
    const newWallpaper = addWallpaperComputables({
        parent: null,
        author,
        isPublic: false,
        src: wallpaperUrl,
        prompt: description,
        colorStats,
        naturalSize:
            originalSize /* <- TODO: [ðŸ§ ] Make naming more clear, what means `naturalSize` and what `originalSize`? */,
        content: contentWithFont,
        saveStage: 'SAVING',
    });

    const insertResult = await getSupabaseForWorker().from('Wallpaper').insert(serializeWallpaper(newWallpaper));

    // TODO: !! Util isInsertSuccessfull (status===201)
    console.info({ newWallpaper, insertResult });
    //-------[ /Save ]---
    //===========================================================================

    return { wallpaperId: newWallpaper.id };
}

/**
 * TODO: [ðŸ¥©] Make version just without prompting
 * TODO: !! Save wallpaperDescription in wallpaper (and maybe whole Azure response)
 * TODO: This function should not know anything that she runs in a worker (getSupabaseForWorker)
 * TODO: `author` must be valid client ID and same as `clientId`
 */
