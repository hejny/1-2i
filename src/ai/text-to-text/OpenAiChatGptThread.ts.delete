import spaceTrim from 'spacetrim';
import { getSupabaseForServer } from '../../utils/supabase/getSupabaseForServer';
import { string_model_name, uuid } from '../../utils/typeAliases';
import { getOpenaiForServer } from './getOpenaiForServer';
import { Prompt } from './prompt-templates/lib/src/classes/Prompt';
import { ChatThread } from './prompt-templates/lib/src/execution/ChatThread';

/**
 * Create conversation with ChatGPT
 *
 * Note: This class is aviable only on the server
 */
export class OpenAiChatGptThread implements ChatThread {
    /**
     * Starts a new ChatThread conversation
     *
     * @param prompt text to send to the OpenAI API
     * @returns response from the OpenAI API wrapped in ChatThread
     */
    public static async ask(prompt: Prompt, clientId: uuid /* <-[ðŸŒº] */): Promise<OpenAiChatGptThread> {
        return /* not await */ OpenAiChatGptThread.create(null, prompt, clientId);
    }

    /**
     * Makes a prompt to the OpenAI API and returns a response wrapped in ChatThread
     * @private Utility method within the class ChatThread
     */
    private static async create(
        parentChatThread: null | OpenAiChatGptThread,
        prompt: Prompt,
        clientId: uuid /* <-[ðŸŒº] */,
    ): Promise<OpenAiChatGptThread> {
       
    }

    private constructor(
        public readonly clientId: uuid /* <-[ðŸŒº] */,
        public readonly parent: null | OpenAiChatGptThread,
        public readonly model: string_model_name,
        public readonly prompt: Prompt,
        public readonly response: string,
    ) {}

    /**
     * Continues in ChatThread conversation
     *
     * @param prompt text to send to the OpenAI API
     * @returns response from the OpenAI API wrapped in ChatThread
     */
    public async ask(prompt: Prompt): Promise<OpenAiChatGptThread> {
        return /* not await */ OpenAiChatGptThread.create(this, prompt, this.clientId);
    }

    public get chatSize(): number {
        return this.parent ? this.parent.chatSize + 1 : 1;
    }
}

/**
 * TODO: !!!last Go through this file and remove it
 * TODO: [ðŸ§ ] Rename ChatThread -> OpenAiChatGptThread
 * TODO: [ðŸ§­] !! This should be under Make @ptp/openai-tools
 * TODO: [âœ”] Check ModelRequirements here
 * TODO: [ðŸ§ ] Wording: response or answer?
 * TODO: [ðŸšž] DRY ChatThread+completeWithGpt
 * TODO: [5] Log also failed prompt as in completeWithGpt
 * TODO: Make IAskOptions
 */
